<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@5.0.0/bundles/stomp.umd.min.js"></script>
  <link rel="stylesheet" href="./style.css">
</head>

<body>
  <section class="container">
    <div class="one">
      <textarea id="student-input" class="full-size-text"></textarea>
    </div>
    <div class="two">
      <div id="master-output" class="text-display"></div>
    </div>
  </section>
</body>
<script>
  const classroomId = "a";
  const myDocumentId = "my-student-doc";
  var currentMasterDocument = null;

  const source = document.getElementById('student-input');
  const masterOutput = document.getElementById('master-output');

  const displayMasterDocument = (masterDocument) => {
    if (!masterDocument || !masterDocument.revisionTime || (
      currentMasterDocument && currentMasterDocument.revisionTime > masterDocument.revisionTime)) {
      console.log("ignore", currentMasterDocument, masterDocument);
      return;
    }
    masterOutput.innerHTML = "Master document<br />" + masterDocument.content;
    currentMasterDocument = masterDocument;
  }

  const stompClient = new StompJs.Client({
    brokerURL: 'ws://localhost:8080/classroom',
    debug: function (str) {
      // Debug logging
      console.log(str);
    },
    reconnectDelay: 100,
    heartbeatIncoming: 4000,
    heartbeatOutgoing: 4000,
  });

  stompClient.onConnect = function (frame) {
    // Do something, all subscribes must be done is this callback
    // This is needed because this will be executed after a (re)connect
    stompClient.subscribe('/topic/classroom/' + classroomId + '/master', function (message) {
      message.body && displayMasterDocument(JSON.parse(message.body));
    });

    // Initial load of master document
    fetch('http://localhost:8080/classroom/' + classroomId + '/master-document')
      .then(response => response.text())
      .then(response => response && displayMasterDocument(JSON.parse(response)));

    // Initial load of own document
    fetch('http://localhost:8080/classroom/' + classroomId + '/document/' + myDocumentId)
      .then(response => response.text())
      .then(response => {
        if (!response) return;
        const parsedDoc = JSON.parse(response);
        source.value = parsedDoc.content
      });
  };

  stompClient.onStompError = function (frame) {
    // Will be invoked in case of error encountered at Broker
    console.log('Broker reported error: ' + frame.headers['message']);
    console.log('Additional details: ' + frame.body);
  };

  stompClient.activate();

  const inputHandler = function (e) {
    stompClient.publish({
      destination: '/app/classroom/' + classroomId + '/document/' + myDocumentId + '/update',
      body: e.target.value || " ", // replace empty strings with a space
    });
  }
  source.addEventListener('input', inputHandler);
  source.addEventListener('propertychange', inputHandler); // for IE8
</script>

</html>